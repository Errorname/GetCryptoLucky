<!doctype html>
<html>
	<head>
		<title>Get Crypto-Lucky</title>

		<meta charset="utf-8">
	</head>
	<body>
		<h1>Get Crypto-Lucky</h1>
		<div id="app">

			<button type="button" @click="getLucky()">Get Lucky</button>
			<br><br>
			<b>Previous addresses:</b>
			<table>
				<thead>
					<tr>
						<th>Address pair (public/wif)</th>
						<th>Coin</th>
						<th>Amount</th>
						<th>Price</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="address in addresses">
						<td>
							<small>{{ address.pair.publicAddress }}</small><br>
							<small>{{ address.pair.privateWif }}</small>
						</td>
						<td>{{ address.coin.name }}</td>
						<td>{{ address.amount }}{{ address.coin.symbol }}</td>
						<td>{{ address.price }}$</td>
					</tr>
				</tbody>
			</table>

		</div>

		<script src="libs/jquery.min.js"></script>
		<script src="libs/vue.js"></script>
		<script src="libs/coinkey.bundle.js"></script>
		<script src="libs/coininfo.bundle.js"></script>
		<script src="coins.js"></script>
		<script>

			var app = new Vue({
				el: '#app',
				data: {
					addresses: [],
					coins: window.coins
				},
				mounted: function() {
					for (var code in this.coins) {
						this.initCoin(this.coins[code]);
					}
				},
				methods: {
					pickRandomCoin: function() {
						var keys = Object.keys(this.coins);
						return this.coins[keys[Math.floor(keys.length * Math.random())]];
					},
					createPair: function(coin) {
						return coinkey.createRandom(coininfo(coin.code));
					},
					checkBalance: function(coin, address, callback) {
						//callback(0);
						var url = coin.api.url.replace('{address}',address);
						var success = function(data) {
							callback(coin.api.callback(data));
						}
						if (coin.api.proxy) {
							$.ajax('proxy.php',{
								data: {
									csurl: url
								},
								success: success
							});
						} else {
							$.ajax(url,{
								success: success
							});
						}
					},
					initCoin: function(coin) {
						$.ajax('https://api.cryptonator.com/api/ticker/'+coin.code+'-usd',{
							success: function(data) {
								coin.price = parseFloat(data.ticker.price);
							}
						});
					},
					getLucky: function() {

						var coin = this.pickRandomCoin();
						var pair = this.createPair(coin);

						address = pair.publicAddress;
						//address = "16rCmCmbuWDhPjWTrpQGaU3EPdZF7MTdUk";

						this.checkBalance(coin, address, function(amount) {
							var address = {
								coin: coin,
								amount: amount,
								price: amount * coin.price,
								pair: pair
							};
							this.addresses.unshift(address);
							//console.log(address);
						}.bind(this));
					}
				}
			});

		</script>
	</body>
</html>
