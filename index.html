<!doctype html>
<html>
	<head>
		<title>Get Crypto-Lucky</title>

		<meta charset="utf-8">

		<link rel="stylesheet" href="libs/spectre/spectre.min.css">
		<link rel="stylesheet" href="libs/spectre/spectre-icons.min.css">
		<style>
			.card .card-header {
				padding-bottom: 0.8rem;
			}

			#history td {
				padding: 0 0.4rem;
			}
		</style>
	</head>
	<body>
		<div id="app" class="container grid-lg text-center">
			<h1 style="margin-top: 1rem; margin-bottom: 1rem;">Get Crypto-Lucky</h1>

			<div id="main" class="card">
				<div class="card-body">
					<a class="btn btn-success" @click="getLucky">Get Lucky</a>
				</div>
			</div>

			<div id="history" class="card mt-2">
				<div class="card-header bg-secondary">
					<div class="card-title h5">Previous attempts</div>
				</div>
				<div class="card-body">
					<table class="table table-striped">
						<thead>
							<tr>
								<th>Address pair (public/wif)</th>
								<th>Coin</th>
								<th>Amount</th>
								<th>Price</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="address in addresses.slice(0,10)">
								<td>
									<small>{{ address.pair.publicAddress }}</small><br>
									<small>{{ address.pair.privateWif }}</small>
								</td>
								<td>{{ address.coin.name }}</td>
								<td>{{ address.amount }}{{ address.coin.symbol }}</td>
								<td>{{ address.price }}$</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<div id="faq" class="card text-left mt-2">
				<div class="card-header bg-secondary">
					<div class="card-title h5 text-center">
						Frequently Asked Questions
					</div>
				</div>
				<div class="card-body">
					<details class="accordion" open>
						<summary class="accordion-header c-hand">
							<i class="icon icon-arrow-right mr-1"></i>
							<b>Is this legit?</b>
						</summary>
						<div class="accordion-body">
							<blockquote style="margin-left: 0.75rem;">
								<p>Yes or no?</p>
							</blockquote>
						</div>
					</details>
				</div>
			</div>
		</div>

		<script src="libs/jquery.min.js"></script>
		<script src="libs/vue.js"></script>
		<script src="libs/coinkey.bundle.js"></script>
		<script src="libs/coininfo.bundle.js"></script>
		<script src="coins.js"></script>
		<script>

			var app = new Vue({
				el: '#app',
				data: {
					addresses: [],
					coins: window.coins
				},
				mounted: function() {
					for (var code in this.coins) {
						this.initCoin(this.coins[code]);
					}
				},
				methods: {
					pickRandomCoin: function() {
						var keys = Object.keys(this.coins);
						return this.coins[keys[Math.floor(keys.length * Math.random())]];
					},
					createPair: function(coin) {
						return coinkey.createRandom(coininfo(coin.code));
					},
					checkBalance: function(coin, address, callback) {
						//callback(0);
						var url = coin.api.url.replace('{address}',address);
						var success = function(data) {
							callback(coin.api.callback(data));
						}
						if (coin.api.proxy) {
							$.ajax('proxy.php',{
								data: {
									csurl: url
								},
								success: success
							});
						} else {
							$.ajax(url,{
								success: success
							});
						}
					},
					initCoin: function(coin) {
						$.ajax('https://api.cryptonator.com/api/ticker/'+coin.code+'-usd',{
							success: function(data) {
								coin.price = parseFloat(data.ticker.price);
							}
						});
					},
					getLucky: function() {

						var coin = this.pickRandomCoin();
						var pair = this.createPair(coin);

						address = pair.publicAddress;
						//address = "16rCmCmbuWDhPjWTrpQGaU3EPdZF7MTdUk";

						this.checkBalance(coin, address, function(amount) {
							var address = {
								coin: coin,
								amount: amount,
								price: amount * (coin.price || 0),
								pair: pair
							};
							this.addresses.unshift(address);
							//console.log(address);
						}.bind(this));
					}
				}
			});

		</script>
	</body>
</html>
